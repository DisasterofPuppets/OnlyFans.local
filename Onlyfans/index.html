<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Onlyfans.Local</title>
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <style>
	html, body {
	  height: 100%;
	  margin: 0;
	  padding: 0;
	  display: flex;
	  flex-direction: column;
	  overflow: hidden; /* prevent page scroll */
	}

    body {
      font-family: monospace;
      background: #000;
      color: #0f0;
      white-space: pre-wrap;
      overflow-x: hidden;
      animation: screenFlicker 0.8s ease-out;
    }

    body, .crt-title, #log, .cursor {
      font-family: 'Courier New', Consolas, 'Lucida Console', monospace;
    }

	#main {
	  flex: 1;
	  display: flex;
	  flex-direction: column;
	  align-items: stretch;
	  padding: 0 10px;
	  box-sizing: border-box;
	  overflow-y: hidden;
	}

    .title-wrapper {
      display: flex;
      justify-content: center;
      width: 100%;
      margin: 1rem 0;
      padding: 0;
      box-sizing: border-box;
    }

	.crt-title {
	  font-family: monospace;
	  color: #0f0;
	  font-size: 0.75em;
	  white-space: pre;
	  text-align: left;
	  line-height: 1;
	  margin: 0;
	  padding: 0;
	  display: block;
	  box-sizing: border-box;
	  max-width: 100%;
	  overflow-x: hidden;
	}

    .btn-load {
      padding: 16px 40px;
      border: 2px solid #0f0;
      background-color: rgba(0, 0, 0, 0.85);
      color: #0f0;
      font-size: 1.2em;
      font-family: monospace;
      border-radius: 12px;
      cursor: pointer;
      transition: background-color 0.2s ease, transform 0.2s ease;
    }

    .btn-load:hover {
      background-color: rgba(0, 255, 0, 0.15);
      transform: scale(1.05);
    }

	.btn-load:disabled {
	  opacity: 0.4;
	  cursor: not-allowed;
	  filter: grayscale(100%);
	  transform: none; /* cancel hover scale */
	  background-color: rgba(0, 255, 0, 0.05); /* faint glow */
	}

	#log {
	  flex-grow: 1;
	  overflow-y: auto;
	  overflow-x: hidden;
	  padding: 10px;
	  text-align: left;
	  box-sizing: border-box;
	  margin-bottom: 1rem;
	}

	#log-content {
	  max-width: 600px;
	  width: 100%;
	  text-align: left;
	  margin: 0 auto;
	}

    .log-line {
      display: inline;
    }

    .cursor {
      display: inline-block;
      width: 1ch;
      color: #0f0;
      font-weight: bold;
    }

    #log::-webkit-scrollbar { width: 6px; }
    #log::-webkit-scrollbar-track { background: transparent; }
    #log::-webkit-scrollbar-thumb { background-color: #0f0; border-radius: 0; }
    #log::-webkit-scrollbar-button { height: 12px; background-color: transparent; color: #0f0; font-size: 12px; line-height: 12px; text-align: center; padding: 0; }
    #log::-webkit-scrollbar-button:single-button:decrement::after { content: '-'; color: #0f0; }
    #log::-webkit-scrollbar-button:single-button:increment::after { content: '+'; color: #0f0; }

	.servo-buttons {
	  display: flex;
	  justify-content: center;
	  gap: 20px;
	  margin-bottom: 2rem;
	  box-sizing: border-box;
	}

	.servo-btn {
	  padding: 16px 40px;
	  border: 2px solid #0f0;
	  background-color: rgba(0, 0, 0, 0.85);
	  color: #0f0;
	  font-size: 1.2em;
	  font-family: monospace;
	  border-radius: 999px;
	  cursor: pointer;
	  transition: background-color 0.2s ease, transform 0.2s ease;
	}

	.servo-btn:hover {
	  background-color: rgba(0, 255, 0, 0.15);
	  transform: scale(1.05);
	}

	.servo-btn:disabled {
	  opacity: 0.4;
	  cursor: not-allowed;
	  filter: grayscale(100%);
	  transform: none;
	  background-color: rgba(0, 255, 0, 0.05);
	}

    @keyframes screenFlicker {
      0%   { background-color: #0f0; opacity: 0.9; }
      40%  { background-color: #000; opacity: 0.2; }
      70%  { background-color: #030; opacity: 0.6; }
      100% { background-color: #000; opacity: 1; }
    }

	.footer {
	  font-family: monospace;
      background: #000;
	  padding: 10px;
      color: #0f0;
	  display: flex;
	  justify-content: center;
	  gap: 20px;
	  box-sizing: border-box;
	  border-top: 2px solid #0f0;
	  align-items: center;
	}
	
	.footer a {
	  color: #0f0; text-decoration: none; margin: 0 10px;
	}
	.footer a:hover { text-decoration: underline; }

	#restart-btn {
	  position: fixed;
	  bottom: 6px;
	  right: 12px;
	  font-size: 0.7em;
	  padding: 6px 10px;
	  background-color: rgba(0, 0, 0, 0.85);
	  color: #0f0;
	  border: 1px solid #0f0;
	  border-radius: 4px;
	  opacity: 0.4;
	  z-index: 100;
	  font-family: monospace;
	  overflow: hidden;
	  transition: opacity 0.3s ease, transform 0.2s ease;
	  /* --- FIX FOR CENTERING --- */
	  display: flex;
	  align-items: center;
	  justify-content: center;
	}

	.btn-text {
	  position: relative;
	  z-index: 101; /* Ensure text is above the fill-bar (z-index 99) */
	}

	#restart-btn:hover {
	  opacity: 1;
	  transform: scale(1.05);
	  cursor: pointer;
	  background-color: rgba(0, 255, 0, 0.15);
	}

	.fill-bar {
	  position: absolute;
	  top: 0;
	  left: 0;
	  height: 100%;
	  background: #0f0;
	  width: 0%;
	  z-index: 99;
	  transition: width 0s;
	  pointer-events: none;
	  border-radius: 4px;
	}

	#restart-btn.holding .fill-bar {
	  animation: fillHold 2s linear forwards;
	  animation-fill-mode: forwards;
	  animation-iteration-count: 1; /* Prevent cycling */
	}

	@keyframes fillHold {
	  from { width: 0%; }
	  to   { width: 100%; }
	}

  </style>

<script>
  let doorState = null;
  let doorCooldown = false;
  let holdTimer;
  let restartTriggered = false;

  function senddoorCommand(path) {
    if (doorCooldown) return;
    doorCooldown = true;

    document.getElementById('open-btn').disabled = true;
    document.getElementById('close-btn').disabled = true;

    fetch(path)
      .catch(err => console.warn(`door command failed: ${path}`, err))
      .finally(() => {
        setTimeout(() => {
          doorState = path.includes('open') ? 'open' : 'closed';
          updatedoorButtons();
          doorCooldown = false;
        }, 1500);
      });
  }


	function sendCommand() {
	  if (doorCooldown) return;
	  
	  const input = document.getElementById('command-input');
	  const sendBtn = document.getElementById('send-btn'); // Get by ID
	  const cmd = input.value.trim();
	  
	  if (!cmd) return;
	  
	  doorCooldown = true;
	  sendBtn.disabled = true;  // Grey out send button
	  
	  fetch('/command?cmd=' + encodeURIComponent(cmd))
		.then(r => r.text())
		.then(response => {
		  // Command response gets added to log automatically via fetchLog()
		})
		.finally(() => {
		  setTimeout(() => {
			doorCooldown = false;
			sendBtn.disabled = false;  // Re-enable send button
		  }, 1500);
		});
		
	  input.value = ''; // Clear input
	}


  function restartESP(btn) {
    restartTriggered = true;
    btn.querySelector('.btn-text').textContent = 'Restarting...';
    btn.disabled = true;

    fetch('/restart').catch(error => {
      console.log('Fetch to /restart failed as expected because the server is already restarting.');
    });

    checkServerStatus();
  }

  function checkServerStatus() {
    const checkInterval = setInterval(() => {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 2000);

      fetch('/log', { method: 'GET', cache: 'no-cache', signal: controller.signal })
        .then(response => {
          if (response.ok) {
            clearInterval(checkInterval);
            window.location.reload();
          }
        })
        .catch(() => console.log('Server still restarting...'))
        .finally(() => clearTimeout(timeoutId));
    }, 1000);

    const failureTimeout = setTimeout(() => {
      clearInterval(checkInterval);
      const restartBtn = document.getElementById('restart-btn');
      if (restartBtn && restartTriggered) {
        restartBtn.querySelector('.btn-text').textContent = 'Restarting';
        restartBtn.classList.remove('holding');
        
        setTimeout(() => {
          restartBtn.querySelector('.btn-text').textContent = 'Restart Server';
          restartBtn.disabled = false;
          restartTriggered = false;
        }, 2000);
      }
    }, 5000);
  }

  function updatedoorButtons() {
    const openBtn = document.getElementById('open-btn');
    const closeBtn = document.getElementById('close-btn');
    if (!openBtn || !closeBtn) return;
    openBtn.disabled = doorState === 'open';
    closeBtn.disabled = doorState === 'closed';
  }

  function escapeHTML(str) {
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  }

  function fetchLog() {
     if (doorCooldown) return Promise.resolve();
     return fetch('/log')
      .then(r => r.text())
      .then(text => {
        const logEl = document.getElementById('log-content');
		const scrollContainer = document.getElementById('log');
        const lines = text.split('\n');
        const escapedLines = lines.map(escapeHTML);
        const lastLine = escapedLines.pop() || '';
        logEl.innerHTML = escapedLines.join('<br>') +
          '<br><span class="log-line">' + lastLine +
          '<span class="cursor">_</span></span>';
        scrollContainer.scrollTop = scrollContainer.scrollHeight;
      }).catch(err => { /* Gracefully handle fetch errors if server is down */ });
  }

  function fetchdoorState() {
    fetch('/door-status')
      .then(r => r.json())
      .then(data => {
        doorState = data.state;
        updatedoorButtons();
      }).catch(err => { doorState = 'closed'; updatedoorButtons(); });
  }

  window.addEventListener('DOMContentLoaded', () => {
    fetchdoorState();
    fetchLog();
	
	const commandInput = document.getElementById('command-input');
    if (commandInput) {
        commandInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendCommand();
            }
        });
    }

    const restartBtn = document.getElementById('restart-btn');
    if (restartBtn) {
      const startHold = (e) => {
        e.preventDefault();
        if (restartTriggered) return;
        restartBtn.classList.add('holding');
        holdTimer = setTimeout(() => {
          restartESP(restartBtn);
        }, 2000);
      };

      const cancelHold = () => {
        clearTimeout(holdTimer);
        if (!restartTriggered) {
          restartBtn.classList.remove('holding');
        }
      };

      restartBtn.addEventListener('mousedown', startHold);
      restartBtn.addEventListener('mouseup', cancelHold);
      restartBtn.addEventListener('mouseleave', cancelHold);
      restartBtn.addEventListener('touchstart', startHold, { passive: false });
      restartBtn.addEventListener('touchend', cancelHold);
      restartBtn.addEventListener('touchcancel', cancelHold);
    }

    setInterval(() => {
      const liveCursor = document.querySelector('.cursor');
      if (liveCursor) {
        const cursorStates = ['_', ' ', '█', ' '];
        let cursorIndex = parseInt(liveCursor.dataset.index || '0');
        liveCursor.textContent = cursorStates[cursorIndex];
        liveCursor.dataset.index = (cursorIndex + 1) % cursorStates.length;
      }
    }, 200);

    
	    (function pollLog() {
      fetchLog().finally(() => {
        // After the fetch completes (success or fail), wait 500ms and poll again.
        setTimeout(pollLog, 500);
      });
    })();
	
  });
</script>

</head>
<body>
  <div id="main">
    <div class="title-wrapper">
		<pre class="crt-title">
░▒▓██████▓▒░  ░▒▓███████▓▒░  ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░ ░▒▓████████▓▒░  ░▒▓██████▓▒░  ░▒▓███████▓▒░   ░▒▓███████▓▒░          ░▒▓█▓▒░         ░▒▓██████▓▒░   ░▒▓██████▓▒░   ░▒▓██████▓▒░  ░▒▓█▓▒░
░▒▓█▓▒░░▒▓█▓▒░ ░▒▓█▓▒░░▒▓█▓▒░ ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░ ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░ ░▒▓█▓▒░░▒▓█▓▒░ ░▒▓█▓▒░                 ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░ ░▒▓█▓▒░░▒▓█▓▒░ ░▒▓█▓▒░░▒▓█▓▒░ ░▒▓█▓▒░
░▒▓█▓▒░░▒▓█▓▒░ ░▒▓█▓▒░░▒▓█▓▒░ ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░ ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░ ░▒▓█▓▒░░▒▓█▓▒░ ░▒▓█▓▒░                 ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░ ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░ ░▒▓█▓▒░
░▒▓█▓▒░░▒▓█▓▒░ ░▒▓█▓▒░░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓██████▓▒░  ░▒▓██████▓▒░   ░▒▓████████▓▒░ ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓██████▓▒░           ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░ ░▒▓█▓▒░        ░▒▓████████▓▒░ ░▒▓█▓▒░
░▒▓█▓▒░░▒▓█▓▒░ ░▒▓█▓▒░░▒▓█▓▒░ ░▒▓█▓▒░           ░▒▓█▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░ ░▒▓█▓▒░░▒▓█▓▒░        ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░ ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░ ░▒▓█▓▒░
░▒▓█▓▒░░▒▓█▓▒░ ░▒▓█▓▒░░▒▓█▓▒░ ░▒▓█▓▒░           ░▒▓█▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░ ░▒▓█▓▒░░▒▓█▓▒░        ░▒▓█▓▒░ ░▒▓██▓▒░ ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░ ░▒▓█▓▒░░▒▓█▓▒░ ░▒▓█▓▒░░▒▓█▓▒░ ░▒▓█▓▒░
 ░▒▓██████▓▒░  ░▒▓█▓▒░░▒▓█▓▒░ ░▒▓████████▓▒░    ░▒▓█▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░ ░▒▓█▓▒░░▒▓█▓▒░ ░▒▓███████▓▒░  ░▒▓██▓▒░ ░▒▓████████▓▒░  ░▒▓██████▓▒░   ░▒▓██████▓▒░  ░▒▓█▓▒░░▒▓█▓▒░ ░▒▓████████▓▒░
		</pre>
	</div>


    <div id="log"><div id="log-content">Loading log...</div></div>

	<div style="display: flex; justify-content: center; margin: 1rem 0;">
	  <div style="display: flex; align-items: center; gap: 10px;">
		<span style="color: #0f0; font-family: monospace;">></span>
		<input type="text" id="command-input" placeholder="Enter h" 
			   style="background: #000; color: #0f0; border: 1px solid #0f0; padding: 8px 12px; font-family: monospace; width: 200px;">
		<button id="send-btn" class="servo-btn" onclick="sendCommand()" style="padding: 8px 16px;">Send</button>
	  </div>
	</div>


    <div class="servo-buttons">
      <button id="open-btn" class="btn-load" onclick="senddoorCommand('/open')">Open door</button>
      <button id="close-btn" class="btn-load" onclick="senddoorCommand('/close')">Close door</button>
    </div>

    <div class="footer">
    <a href="http://disasterofpuppets.com" target="_blank">Disaster's YouTube Channel</a>
	<div class="divider"> | </div>
    <a href="https://github.com/DisasterofPuppets/OnlyFans.local" target="_blank">Disaster's GitHub</a>
  </div>
    <button id="restart-btn">
		<div class="fill-bar"></div>
		<span class="btn-text">Restart Server</span>
	</button>
</body>
</html>